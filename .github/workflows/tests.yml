# ==============================================================================
# PIPELINE
# ==============================================================================
name: Tests

# ==============================================================================
# TRIGGERS
# ==============================================================================
on:
    push:
        branches:
            - '**'

# ==============================================================================
# PERMISSIONS
# ==============================================================================
permissions:
    contents: read

# ==============================================================================
# DEFAULTS
# ==============================================================================
defaults:
    run:
        shell: bash

jobs:

    # ==========================================================================
    # JOB: TESTS
    # ==========================================================================
    tests:
        name: Test / PHP ${{ matrix.php }}
        runs-on: ubuntu-latest-large

        env:
            VALKEY_GLIDE_VERSION: 1.0.0

        strategy:
            fail-fast: true
            matrix:
                php: [ 8.3 ]

        concurrency:
            group: tests-${{ github.workflow }}-${{ github.ref }}
            cancel-in-progress: true

        services:
            redis:
                image: redis:7-alpine
                ports:
                    - 6379:6379
                options: >-
                    --health-cmd "redis-cli ping"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: ${{ matrix.php }}
                    extensions: dom, bcmath
                    coverage: pcov
                    tools: composer, pie

            -   name: Install system dependencies
                run: |
                    sudo apt-get update -qq
                    sudo apt-get install -y --no-install-recommends \
                        libprotobuf-c-dev

            -   name: Cache Composer cache
                uses: actions/cache@v4
                with:
                    path: ~/.composer/cache
                    key: composer-cache-${{ runner.os }}-${{ matrix.php }}-${{ hashFiles('**/composer.lock') }}
                    restore-keys: composer-cache-${{ runner.os }}-

            -   name: Cache PIE
                uses: actions/cache@v4
                with:
                    path: |
                        ~/.config/pie
                        ~/.cache/pie
                    key: pie-cache-${{ runner.os }}-${{ matrix.php }}-${{ env.VALKEY_GLIDE_VERSION }}
                    restore-keys: pie-cache-${{ runner.os }}-${{ matrix.php }}-

            -   name: Install Valkey GLIDE extension
                run: |
                    set -euo pipefail

                    if ! pie install --make-parallel-jobs 1 "valkey-io/valkey-glide-php:${VALKEY_GLIDE_VERSION}"; then
                        log_file="$(ls -t /tmp/pie_make_output_* 2>/dev/null | head -n 1 || true)"

                        echo '=== PIE debug context ==='
                        php -v
                        php-config --version
                        php-config --includes
                        command -v pkg-config || true
                        pkg-config --modversion protobuf-c || true
                        pkg-config --modversion openssl || true
                        dpkg -l | grep -E 'protobuf|ssl|clang|rust|cargo|cmake' || true

                        if [ -n "${log_file}" ]; then
                            echo "Using log file: ${log_file}"
                            cp "${log_file}" pie_make_output.log
                            echo '=== PIE make output (last 300 lines) ==='
                            tail -n 300 "${log_file}"
                        fi

                        exit 1
                    fi

                    php -m | grep -i '^valkey_glide$'

            -   name: Upload PIE debug artifact
                if: ${{ failure() }}
                uses: actions/upload-artifact@v4
                with:
                    name: pie-debug-php-${{ matrix.php }}
                    path: |
                        pie_make_output.log
                        /tmp/pie_make_output_*
                    if-no-files-found: ignore

            -   name: Cache vendor
                uses: actions/cache@v4
                with:
                    path: vendor
                    key: vendor-${{ runner.os }}-${{ matrix.php }}-${{ hashFiles('**/composer.lock') }}
                    restore-keys: |
                        vendor-${{ runner.os }}-${{ matrix.php }}-

            -   name: Install Composer dependencies
                run: composer install --prefer-dist --no-interaction --no-progress

            -   name: PHPUnit
                run: composer test

            -   name: PHPUnit External
                run: composer test-external

            -   name: PHPUnit + Coverage
                if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/master' }}
                run: composer test-coverage

            -   name: Publish code coverage
                if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/master' }}
                uses: qltysh/qlty-action/coverage@v1
                with:
                    token: ${{ secrets.QLTY_COVERAGE_TOKEN }}
                    files: clover.xml
